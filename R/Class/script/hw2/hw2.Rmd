---
title: "R Notebook"
output: html_notebook
---

```{r}

gen_utagmat <- function(utagvec,y){
    
# Create a tag vector containing the user_tags column split by commas
utagvec <- strsplit(utagvec, ",")
  
# Unlist the tag vector 
vec<-unlist(utagvec)

# Sort the tag vector by order 
sortags <- sort(table(vec), decreasing=TRUE)

# Filter out the tags that occur less than 5 times
filtags <- sortags[sortags >= 5]

### Computing t-value for each tag ###

# Create a named vector with the same length as the tag vector and set all values to NA
fillen <- length(filtags)
filname <- names(filtags)
alltags <- structure(rep(NA, fillen), names=filname)

# Select the column containing the target values
tar <- rtb1_train$paying_price

# Compute and store the t-stats for each tag
for(iter in 1:fillen){
  # Get feature name
  feat <- filname[iter]
  # Store the numerical value of whether the feature exists in the tag vector
  pred <- sapply(utagvec, function(taglist) as.numeric(is.element(feat, unlist(taglist))))
  # Store the t-statistic for each tag in "alltags", NOTE "~" for binary predictor!
  # Check names(summary(lm(tar~pred))) to find the corresponding entry
  alltags[iter] <- summary(lm(tar~pred))$coefficient[2,3]
  }

# Filter out the tags with absolute value of t-stat less than 1, and order the vector
seltags <- alltags[abs(alltags) >= 1]
seltags <- sort(abs(seltags), decreasing = TRUE)
sellen <- length(seltags)
selname <- names(seltags)

# Create output matrix
for(seliter in 1:sellen){
  # Get feature name
  selfeat <- selname[seliter]
  # Store the numerical value of whether the feature exists in the tag vector
  selpred <- sapply(utagvec, function(taglist) as.numeric(is.element(selfeat, unlist(taglist))))
  # Combine the columns in to one dataframe 
  if(seliter == 1){
    opmatrix <- data.frame(selpred)
  }
  opmatrix <- cbind(opmatrix,data.frame(selpred))
}

# Name the output matrix
colnames(opmatrix) <- paste("user",selname, sep = "_")
opmatrix <- opmatrix[,-ncol(opmatrix)]
opmatrix <- as.matrix(cbind(constant=1,opmatrix))

# Return the required the matrix
return(opmatrix)
}

```

```{r}
###　Testing ###
load("C:/Users/Willy/OneDrive/公用/台大/Senior courses/Second semester/Statistical Learning/R/Class/data/rtb1_train.rdata")
rtb1_train <- rtb1_train[1:300,]

umat1 = gen_utagmat(rtb1_train$user_tags, rtb1_train$paying_price)
head(umat1)

#y = rtb1_train$paying_price
#w = solve(t(umat1) %*% umat1, t(umat1) %*% y)
#print(w)


```


